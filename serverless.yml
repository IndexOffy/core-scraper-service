service: indexoffy-api

frameworkVersion: '3'

provider:
  name: aws
  region: ${self:custom.region}
  timeout: 900
  memorySize: 3008
  stage: ${self:custom.stage}
  deploymentBucket:
    name: ${self:service}-${self:provider.stage}-deployment-${self:provider.region}
    blockPublicAccess: true
  httpApi:
    cors: true

  ecr:
    images:
      appImage:
        uri: ${env:ECR_REPOSITORY_URI}:${self:custom.stage}-${self:provider.region}

  environment:
    SCOPE: ${self:custom.scope.${self:provider.stage}, 'production'}
    DATABASE_URL: ${env:DATABASE_URL, ''}
    API_VERSION: ${env:API_VERSION, '0.1.0'}
    CORS_ORIGINS: ${env:CORS_ORIGINS, '["*"]'}
    TOR_BROWSER_PATH: ${env:TOR_BROWSER_PATH, ''}
    TOR_DATA_DIR: ${env:TOR_DATA_DIR, '/tmp/tor-data'}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'
        - Effect: Allow
          Action:
            - ecr:GetAuthorizationToken
            - ecr:BatchCheckLayerAvailability
            - ecr:GetDownloadUrlForLayer
            - ecr:BatchGetImage
          Resource: '*'
        - Effect: Allow
          Action:
            - s3:CreateBucket
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::${self:service}-${self:provider.stage}-deployment-${self:provider.region}
            - arn:aws:s3:::${self:service}-${self:provider.stage}-deployment-${self:provider.region}/*

functions:
  api:
    image:
      uri: ${self:provider.ecr.images.appImage.uri}
    events:
      - httpApi:
          path: /{proxy+}
          method: ANY
      - httpApi:
          path: /
          method: ANY

custom:
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  scope:
    dev: development
    prod: production
    test: test

package:
  patterns:
    - '!node_modules/**'
    - '!tests/**'
    - '!.git/**'
    - '!.venv/**'
    - '!venv/**'
    - '!__pycache__/**'
    - '!*.pyc'
    - '!*.pyo'
    - '!*.pyd'
    - '!.pytest_cache/**'
    - '!.mypy_cache/**'
    - '!*.md'
    - '!*.txt'
    - '!.gitignore'
    - '!pytest.ini'
    - 'opt/tor-browser/**'
    - 'scripts/**'
