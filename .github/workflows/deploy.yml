name: ğŸš€ Deploy to AWS Lambda

on:
  push:
    branches:
      - master
      - develop
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to deploy (dev/prod)'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  code-quality:
    uses: ./.github/workflows/code-quality.yml

  test:
    uses: ./.github/workflows/test.yml

  deploy:
    name: Deploy to AWS Lambda
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (
        (github.ref == 'refs/heads/master' && needs.code-quality.result == 'success' && needs.test.result == 'success') ||
        (github.event.inputs.stage == 'prod' && needs.code-quality.result == 'success' && needs.test.result == 'success') ||
        (github.ref == 'refs/heads/develop' || github.event.inputs.stage == 'dev')
      )
    environment:
      name: ${{ github.ref == 'refs/heads/master' && 'prod' || github.ref == 'refs/heads/develop' && 'dev' || github.event.inputs.stage }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Environment
        uses: ./.github/actions/setup-environment

      - name: ğŸ” Configure AWS
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: ğŸ” Determine Stage and Scope
        id: deployment
        uses: ./.github/actions/determine-stage
        with:
          event-name: ${{ github.event_name }}
          ref: ${{ github.ref }}
          input-stage: ${{ github.event.inputs.stage }}

      - name: ğŸ“ Generate API Version
        id: version
        uses: ./.github/actions/generate-version
        with:
          run-number: ${{ github.run_number }}

      - name: ğŸš€ Deploy to AWS Lambda
        uses: ./.github/actions/deploy-lambda
        with:
          stage: ${{ steps.deployment.outputs.stage }}
          region: ${{ secrets.AWS_REGION || 'us-east-1' }}
          api-version: ${{ steps.version.outputs.version }}
          cors-origins: ${{ secrets.CORS_ORIGINS || '["*"]' }}
          tor-browser-path: ${{ secrets.TOR_BROWSER_PATH || '' }}
          tor-data-dir: ${{ secrets.TOR_DATA_DIR || '' }}
          database-url: ${{ secrets.DATABASE_URL || '' }}

      - name: âœ… Deploy Summary
        if: always()
        uses: ./.github/actions/deploy-summary
        with:
          version: ${{ steps.version.outputs.version }}
          stage: ${{ steps.deployment.outputs.stage }}
          scope: ${{ steps.deployment.outputs.scope }}
          branch: ${{ github.ref_name }}
          commit: ${{ github.sha }}
